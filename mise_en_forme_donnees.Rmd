---
title: "Statistiques descriptives - base complète"
author: "Bracq, Meyer, Sklenard, Berleur"
date: "2023-01-25"
header-includes:
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyhead{}
- \fancyfoot{}
- \fancyhead[CO,CE]{Poing Levé}
- \fancyfoot[CO,CE]{Sondage}
- \fancyfoot[R]{\thepage}
output:
  pdf_document:
    toc: yes
    toc_depth : 3
    latex_engine: xelatex
  html_document:
    toc: yes
editor_options: 
  markdown: 
    wrap: sentence
---

```{=html}
<style>
body {
text-align: justify}
</style>
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

```

```{r, include=FALSE}
list.of.packages <- c("tidyverse", "sf", "readxl", "rgdal", "ggplot2", "data.table", "dplyr", "stargazer", "cartography","sf","rgdal","sp","readr", "sp", "stringr", "questionr")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages, repos = "http://cran.us.r-project.org")

invisible(lapply(list.of.packages, library, character.only = TRUE))

setwd("~/Documents/ENSAE/Stats_app/git") #cathu
```


```{r, charger-libraries}
# ctrl + maj + c : passer la sélection en commentaire

# library(sf)
# library(rgdal)
# library(cartography)
# library(sp)
# library(stringr)
# library(dplyr)
# library(questionr)
```



```{r chargement-dataset}

load("C:\\Users\\marie\\OneDrive\\Documents\\cours\\ensae\\stat app\\donnees.secretisees.delinquance.RData") # marie
#load("~/Documents/ENSAE/Stats_app/Data/donnees.secretisees.delinquance.RData") #cathu
load("C:/Users/Utilisateur/Desktop/donnees.secretisees.delinquance.RData") #clem
# load("/Users/sklenard/Downloads/donnees.secretisees.delinquance.RData")# Gaby 

```


Ce fichier contient un seul objet R, un tibble t.del, comprenant 6,5 millions de lignes et 8 colonnes :
    - id, un identifiant arbitraire.
    - annee, qui ne correspond pas à la vraie année enregistrée, elles ont toutes été permutées.
    - duree_debut_fait_date_enregistrement, qui correspond à la durée écoulée, en jours, entre la date de début des faits et la date d'enregistrement de l'infraction.
    - classe, qui correspond à la forme de délinquance. Les 12 indicateurs sont habituellement suivis par le SSMSI (liste ci-dessous). Leur nom a été remplacé par une lettre arbitraire.
    - dept_serv, le département du service où a été enregistrée l'infraction.
    - un trinôme de communes en géographie figée au 1er janvier 2022 :
    - une commune pour le lieu de commission de l'infraction ;
    - une commune pour le lieu de résidence de la victime (ou siège pour une entreprise, ...) ;
    - une commune pour le lieu de résidence du mis en cause.
          -> pour la secrétisation des données, ce trinôme a été modifiée. Chacune des trois communes a été (ou pas) remplacée par une commune voisine. Les structures géographiques devraient être donc en grande partie conservées.

Ainsi, ce tableau de données  correspond à un échantillon des données de délinquance entre 2016 et 2021, un taux de sondage différent par classe ayant été appliqué.

Liste des différents indicateurs de délinquance :
    - Cambriolages de logement ;
    - Coups et blessures volontaires dans la sphère familiale ;
    - Coups et blessures volontaires en dehors de la sphère familiale ;
    - Destructions et dégradations ;
    - Homicides ;
    - Violences sexuelles ;
    - Vols avec armes ;
    - Vols d'accessoires sur véhicules ;
    - Vols dans les véhicules ;
    - Vols de véhicules ;
    - Vols sans violence contre des personnes ;
    - Vols violents sans arme.


```{r chargement-contours-communes}
# contours <- st_read("C:\\Users\\marie\\OneDrive\\Documents\\cours\\ensae\\stat app\\contoursGeographiques") # marie
# contours <- st_read("C:\\Users\\Utilisateur\\Desktop\\contoursGeographiques") #Clem

contours <- st_read("contoursGeographiques") # vérifier qu'on a bien le dossier git comme working directory -> permet d'avoir toustes la même ligne de code pour charger les contours
```

```{r chargement-zonages-insee}

#depuis github :
urlfile<-'https://raw.githubusercontent.com/marie678/test/main/table-appartenance-geo-communes-22.csv'
zonages <- read.csv(urlfile, header=TRUE,sep=';',fileEncoding='cp1252') #création d'un df pour les zonages
liste_labels <- c('Code géographique','Libellé géographique','Département	Région','Arrondissement','Canton ville','Intercommunalité - Métropole',"Nature d'EPCI","Zone d'emploi 2020",'Unité urbaine 2020',"Tranche d'unité urbaine 2020 calculée sur la population 2017","Tranche détaillée d'unité urbaine 2020 calculée sur la population 2017","Aire d'attraction des villes 2020","Tranche d'aire d'attraction des villes 2020 calculée sur la population 2017","Tranche détaillée d'aire d'attraction des villes 2020 calculée sur la population 2017","Catégorie commune dans aire d'attraction des villes 2020","Bassin de vie 2012")

```



Maintenant on va créer des sous-bases par type de délinquance (variable classe) et par année (on enlève 2020 et 2021).

```{r fonction-découpage}
df_1619 <- subset(t.del, t.del$annee %in% c(2016, 2017, 2018, 2019)) #on sélectionne les années

decoupage_classe_merge <- function(classe_del) {
  df1 <- subset(df_1619, df_1619$classe == classe_del) #on sélectionne un type de délinquance
  df_long <- melt(data = df1, id.vars=c('id',"annee","duree_debut_fait_date_enregistrement","classe","dept_serv"),variable.name='info commune', value.name='commune') # format wide to long
  df_long <- as_tibble(df_long)
  df_geo <- merge(x=contours,y=df_long, by.x='insee',by.y='commune', all.y=TRUE) #jointure avec les contours géo
  df_geo$insee = str_remove(df_geo$insee, "^0+") #pr avoir le même format que zonages
  df_merged <- merge(x=df_geo, y=zonages, by.x='insee', by.y='CODGEO', all.x=TRUE) #jointure avec les zonages insee
  df_merged <- as_tibble(df_merged)
  saveRDS(df_merged, file = paste(paste('del_merged',classe_del,sep = "_"),'rds',sep='.')) # on enregistre le sous df correspondant
}


liste_classe <- unique(t.del$classe) # on récupère une liste de toutes les classes de délinquance
lapply(liste_classe, decoupage_classe_merge) # on applique la fonction à chaque classe pour créer le df correspondant
```



(code en dehors de la fonction si besoin ... :)
On transforme le df en format long pour avoir une colonne 'info commune' (infraction, mec ou victime) et une colonne 'commune'
```{r wide_to_long}
t.del.A
t.del.A_long <- melt(data = t.del.A, id.vars=c('id',"annee","duree_debut_fait_date_enregistrement","classe","dept_serv"),variable.name='info commune', value.name='commune')
t.del.A_long <- as_tibble(t.del.A_long)
```

On merge avec les contours géo et les zonages de l'insee !!
```{r jointures}
t.del.A_geo <- merge(x=contours,y=t.del.A_long, by.x='insee',by.y='commune', all.y=TRUE)
t.del.A_geo$insee = str_remove(t.del.A_geo$insee, "^0+")
t.del.A_merged <- merge(x=t.del.A_geo, y=zonages, by.x='insee', by.y='CODGEO', all.x=TRUE)
t.del.A_merged <- as_tibble(t.del.A_merged)
saveRDS(t.del.A_merged, file = "del_merged_A.rds")

```
