---
title: "Statistiques descriptives - base complète"
author: "Bracq, Berleur, Meyer, Sklenard"
date: "2023-01-25"
header-includes:
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyhead{}
- \fancyfoot{}
- \fancyhead[CO,CE]{Poing Levé}
- \fancyfoot[CO,CE]{Sondage}
- \fancyfoot[R]{\thepage}
output:
  pdf_document:
    toc: yes
    toc_depth : 3
    latex_engine: xelatex
  html_document:
    toc: yes
editor_options: 
  markdown: 
    wrap: sentence
---

```{=html}
<style>
body {
text-align: justify}
</style>
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

```

```{r, include=FALSE}
list.of.packages <- c("tidyverse", "sf", "readxl", "rgdal", "ggplot2", "data.table", "dplyr", "stargazer", "cartography","sf","rgdal","sp","readr", "sp", "stringr", "questionr")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages, repos = "http://cran.us.r-project.org")

invisible(lapply(list.of.packages, library, character.only = TRUE))

setwd("~/Documents/ENSAE/Stats_app/git") #cathu
```


```{r, charger-libraries}
# library(sf)
# library(rgdal)
# library(cartography)
# library(sp)
# library(stringr)
```



```{r chargement-dataset}

# load("C:\\Users\\marie\\OneDrive\\Documents\\cours\\ensae\\stat app\\donnees.secretisees.delinquance.RData") # marie
load("~/Documents/ENSAE/Stats_app/Data/donnees.secretisees.delinquance.RData") #cathu
# load("C:/Users/Utilisateur/Desktop/donnees.secretisees.delinquance.RData") #clem
# load("/Users/sklenard/Downloads/donnees.secretisees.delinquance.RData")# Gaby 
```

Ce fichier contient un seul objet R, un tibble t.del, comprenant 6,5 millions de lignes et 8 colonnes :
    - id, un identifiant arbitraire.
    - annee, qui ne correspond pas à la vraie année enregistrée, elles ont toutes été permutées.
    - duree_debut_fait_date_enregistrement, qui correspond à la durée écoulée, en jours, entre la date de début des faits et la date d'enregistrement de l'infraction.
    - classe, qui correspond à la forme de délinquance. Les 12 indicateurs sont habituellement suivis par le SSMSI (liste ci-dessous). Leur nom a été remplacé par une lettre arbitraire.
    - dept_serv, le département du service où a été enregistrée l'infraction.
    - un trinôme de communes en géographie figée au 1er janvier 2022 :
    - une commune pour le lieu de commission de l'infraction ;
    - une commune pour le lieu de résidence de la victime (ou siège pour une entreprise, ...) ;
    - une commune pour le lieu de résidence du mis en cause.
          -> pour la secrétisation des données, ce trinôme a été modifiée. Chacune des trois communes a été (ou pas) remplacée par une commune voisine. Les structures géographiques devraient être donc en grande partie conservées.

Ainsi, ce tableau de données  correspond à un échantillon des données de délinquance entre 2016 et 2021, un taux de sondage différent par classe ayant été appliqué.

Liste des différents indicateurs de délinquance :
    - Cambriolages de logement ;
    - Coups et blessures volontaires dans la sphère familiale ;
    - Coups et blessures volontaires en dehors de la sphère familiale ;
    - Destructions et dégradations ;
    - Homicides ;
    - Violences sexuelles ;
    - Vols avec armes ;
    - Vols d'accessoires sur véhicules ;
    - Vols dans les véhicules ;
    - Vols de véhicules ;
    - Vols sans violence contre des personnes ;
    - Vols violents sans arme.


Premières stats desc sur toute la base :

```{r tableau-1-prop}
tab1 <- table(t.del$classe, t.del$annee)
prop.table(tab1)*100
#en réflexion... objectif : faire des pourcentages
```

```{r tableau-2}
table(t.del$dept_serv, t.del$classe)
tab2 <- table(t.del$dept_serv, t.del$classe)
```

```{r barplot}
barplot(table(t.del$classe), col = "#1b98e0", main = "Effectifs par classe de délinquance", xlab="Classe de délinquance", ylab = "Effectifs")
```

Trucs en cours :


```{r mosaicplot}
#ici le mosaicplot est illisible : il faudrait créer une variable région
#tab3 <- table(t.del$classe, t.del$region)
mosaicplot(tab2, shade = T, las = 2, main = "Type de délinquance selon le département", xlab= "Départements", ylab="Classe de délinquance")
```


```{r boxplot}
#pas d'intérêt ici mais comme ça on a le code pour en faire un si besoin
boxplot(t.del$annee, main = "titre", ylab= "y")
```

```{r tapply}
#tapply(t.del$, t.del$, , na.rm=TRUE)
#pareil en réflexion
```

```{r nombre-atteintes-par-commune}
compteur <-rep(1,4556381)
df_1619_2 <-cbind(df_1619,compteur)
```

```{r tableaux-infractions-communes}
df1 <- subset(df_1619, df_1619$classe == "A")

df_long <- melt(data = df1, id.vars=c('id',"annee","duree_debut_fait_date_enregistrement","classe","dept_serv"),variable.name='info commune', value.name='commune') # format wide to long

df_long_trie <- arrange(df_long,id)
#on a l'impression que pas mal de commune du lieu d'habitation du mis en cause n'est pas renseigné!

str(df_long_trie)

summary(df_long_trie)

summary(df1)

summary(df_1619$classe)

unique(df_1619$classe)

classe <- table(df_1619$classe)
prop.table(classe)* 100

frequence <- classe*100/sum(classe)

barplot(frequence, 
            horiz = TRUE,las=1, 
            col = "purple", 
            border = "white",
            main ="Répartition des différents types d'atteinte",
            xlab = "Fréquence (en %)")

hdv2003$qualif[hdv2003$qualif == "Ouvrier specialise"] <- "Ouvrier"

 

# Nombre d'atteintes pour lesquelles les 3 lieux sont dans la même commune:
df_1619$indicatrice1 <- 0
df_1619$indicatrice1[(df_1619$cog_com_22_inf == df_1619$cog_com_22_vict) & (df_1619$cog_com_22_inf == df_1619$cog_com_22_mec)] <-1

sum(df_1619$indicatrice1)

# Nombre d'atteintes pour lesquelles les 2 lieux (infraction et victime) sont dans la même commune:
df_1619$indicatrice2 <- 0
df_1619$indicatrice2[(df_1619$cog_com_22_inf == df_1619$cog_com_22_vict)] <-1

sum(df_1619$indicatrice2)

# Nombre d'atteintes pour lesquelles les 2 lieux (infraction et  ) sont dans la même commune:
df_1619$indicatrice2 <- 0
df_1619$indicatrice2[(df_1619$cog_com_22_inf == df_1619$cog_com_22_vict)] <-1

sum(df_1619$indicatrice2)

# on somme par type d'atteintes:
tab1 <- table(df_1619$classe, df_1619$indicatrice1)
prop.table(tab1)*100

tab2 <- table(df_1619$classe, df_1619$indicatrice2)
prop.table(tab2)*100


```

