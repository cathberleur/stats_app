---
title: "Travail sur sous-bases d'1 type de délinquance"
author: "Bracq, Meyer"
date: "2023-01-25"
header-includes:
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyhead{}
- \fancyfoot{}
- \fancyhead[CO,CE]{Poing Levé}
- \fancyfoot[CO,CE]{Sondage}
- \fancyfoot[R]{\thepage}
output:
  pdf_document:
    toc: yes
    toc_depth : 3
    latex_engine: xelatex
  html_document:
    toc: yes
editor_options: 
  markdown: 
    wrap: sentence
---

```{=html}
<style>
body {
text-align: justify}
</style>
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

```

```{r, include=FALSE}
list.of.packages <- c("tidyverse", "haven", "readxl", "stats", "ggplot2", "ggcorrplot", "data.table", "dplyr", "corrplot", "stargazer", "Hmisc",'cartography','sf','rgdal','sp','gdata')
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages, repos = "http://cran.us.r-project.org")

invisible(lapply(list.of.packages, library, character.only = TRUE))

setwd("~/Documents/ENSAE/Stats_app")
```


```{r, charger-libraries}
library(sf)
library(rgdal)
library(cartography)
library(sp)
library(dplyr)
library(tibble)
library(data.table)
library(reshape2)
library(tidyr)
library(gdata)
```

A exécuter après la feuille mise_en_forme_donnees (ou changer le lien de chargement des fichiers si ils sont enregistrés ailleurs pour ne pas les recréer inutilement à chaque fois)

```{r, chargement-d-une-sous-base}
load("C:\\Users\\marie\\OneDrive\\Documents\\cours\\ensae\\stat app\\donnees.secretisees.delinquance.RData") # marie

#t.del.A <- readRDS("~/GitHub/stats_app/del_merged_A.rds")
#t.del.O <- readRDS("~/GitHub/stats_app/del_merged_O.rds")
#t.del.K <- readRDS("~/GitHub/stats_app/del_merged_K.rds")

```

```{r chargement-sous-bases}

liste_classe <- unique(t.del$classe) # on récupère une liste de toutes les classes de délinquance


for (classe in liste_classe) {
  nom_doc <- paste((paste('del_merged',classe, sep='_')),'rds',sep='.')
  objet <- readRDS(paste("~/GitHub/stats_app/",nom_doc,sep=''))
  mv('objet', paste('t.del',classe, sep='.')) #renommer le df
  print(classe)
}

#prend 3-4 minutes, les df s'affichent à la fin l'un après l'autre (1-2 min)
```
à améliorer (peut marcher avec append dans la boucle où on les charge mais j'ai l'impression que ça prend bcp plus de temps)
```{r liste-t.del}

liste_df <- list(t.del.B, t.del.V, t.del.A, t.del.K, t.del.T, t.del.W, t.del.O, t.del.G, t.del.R, t.del.X, t.del.S, t.del.D) #1 min
```


On cherche quels zonages permettent au mieux de regrouper les trois adresses d'une observation :
pour cela, on créee une indicatrice qui indique si les 3 communes appartiennent au même zonage ou non, pour chaque zonage
(on fait ensuite la somme pour avoir l'effectif / proportion)

idem avec 2 communes --> il faut faire infraction + mec et infraction + victime et? victime + mec ? (est-ce que toutes ces infos sont pertinentes ??)

il faut encore ajouter une partie pour les comparaison 2 à 2, peut être que le plus simple est de refaire 2 autres fonctions similaires pour ne pas trop se compliquer la vie ?

#METHODE 3
après discussion avec Aurélien, on retente de repasser le format long en wide après les jointures

transformer méthode 3 en fonction
```{r fonction-effectifs}

compteur_zonages <- function(zonage,df) {
  df_wide <- pivot_wider(data=df, names_from = 'info commune', id_cols = 'id', values_from = zonage)
  nom_colonne <- (paste('indic',zonage,sep = "_"))
  df_wide[nom_colonne] <- case_when(
  ((df_wide$cog_com_22_mec == df_wide$cog_com_22_vict) & ( df_wide$cog_com_22_mec == df_wide$cog_com_22_inf)) ~ 1,
  TRUE ~ 0) # 1 si les 3 zonages sont les mêmes, 0 sinon
  denominateur <- length(unique(df$id))
  effectif <- sum(df_wide[nom_colonne])
  proportion <- effectif/denominateur
  
  cat(zonage, ' : ', effectif,', ', proportion*100, '%\n')
}


#lapply(liste_zonages, compteur_zonages)
#compteur_zonages('EPCI',t.del.K)
#outer(liste_zonages, liste_df2, FUN = compteur_zonages)

liste_zonages <- colnames(t.del.O)[14:26] # on récupère une liste de tous les types de zonages (colonne arrondissement à la fin)
sapply(liste_zonages, function(x) mapply(compteur_zonages,x,liste_df))


```

voir comment résumer ces infos plus joliment (mais c'est déjà un bon début)
'''
> sapply(liste_zonages, function(x) mapply(compteur_zonages,x,liste_df))
ARR  :  13419 ,  2.907201 %
ARR  :  159185 ,  48.30331 %
ARR  :  51725 ,  27.36454 %
ARR  :  32061 ,  3.715593 %
ARR  :  130514 ,  37.07521 %
ARR  :  74484 ,  7.903801 %
ARR  :  8523 ,  17.46337 %
ARR  :  5380 ,  2.064673 %
ARR  :  18136 ,  3.821219 %
ARR  :  15582 ,  4.343645 %
ARR  :  21148 ,  7.77929 %
ARR  :  1467 ,  33.56211 %
CV  :  3071 ,  0.6653263 %
CV  :  56028 ,  17.00121 %
CV  :  16311 ,  8.629154 %
CV  :  9644 ,  1.117656 %
CV  :  39061 ,  11.09609 %
CV  :  21120 ,  2.241129 %
CV  :  2633 ,  5.394939 %
CV  :  1489 ,  0.5714308 %
CV  :  4859 ,  1.023781 %
CV  :  4192 ,  1.168564 %
CV  :  4499 ,  1.654957 %
CV  :  512 ,  11.71357 %
EPCI  :  12549 ,  2.718717 %
EPCI  :  139334 ,  42.27969 %
EPCI  :  40404 ,  21.37529 %
EPCI  :  29438 ,  3.41161 %
EPCI  :  111358 ,  31.63355 %
EPCI  :  63571 ,  6.745778 %
EPCI  :  7433 ,  15.23 %
EPCI  :  4671 ,  1.792581 %
EPCI  :  16205 ,  3.414361 %
EPCI  :  13225 ,  3.686606 %
EPCI  :  22606 ,  8.315615 %
EPCI  :  1245 ,  28.48318 %
NATURE_EPCI  :  15815 ,  3.42629 %
NATURE_EPCI  :  175375 ,  53.21602 %
NATURE_EPCI  :  57336 ,  30.33298 %
NATURE_EPCI  :  38770 ,  4.493109 %
NATURE_EPCI  :  146099 ,  41.50245 %
NATURE_EPCI  :  80516 ,  8.543881 %
NATURE_EPCI  :  10255 ,  21.01219 %
NATURE_EPCI  :  6497 ,  2.493342 %
NATURE_EPCI  :  21364 ,  4.501352 %
NATURE_EPCI  :  17944 ,  5.002077 %
NATURE_EPCI  :  27529 ,  10.12654 %
NATURE_EPCI  :  1625 ,  37.17685 %
ZE2020  :  16214 ,  3.512732 %
ZE2020  :  180145 ,  54.66344 %
ZE2020  :  58601 ,  31.00221 %
ZE2020  :  39163 ,  4.538654 %
ZE2020  :  150743 ,  42.82167 %
ZE2020  :  84961 ,  9.015558 %
ZE2020  :  9796 ,  20.07171 %
ZE2020  :  6294 ,  2.415437 %
ZE2020  :  21317 ,  4.491449 %
ZE2020  :  18131 ,  5.054205 %
ZE2020  :  27862 ,  10.24903 %
ZE2020  :  1637 ,  37.45138 %
UU2020  :  11820 ,  2.560781 %
UU2020  :  123611 ,  37.50869 %
UU2020  :  37082 ,  19.61782 %
UU2020  :  26862 ,  3.113074 %
UU2020  :  99573 ,  28.28578 %
UU2020  :  55844 ,  5.925835 %
UU2020  :  7320 ,  14.99846 %
UU2020  :  4571 ,  1.754204 %
UU2020  :  15567 ,  3.279935 %
UU2020  :  11901 ,  3.317528 %
UU2020  :  23353 ,  8.590399 %
UU2020  :  1074 ,  24.57104 %
TUU2017  :  12841 ,  2.781978 %
TUU2017  :  132321 ,  40.15166 %
TUU2017  :  41585 ,  22.00008 %
TUU2017  :  29417 ,  3.409177 %
TUU2017  :  108112 ,  30.71146 %
TUU2017  :  60301 ,  6.398785 %
TUU2017  :  7945 ,  16.27907 %
TUU2017  :  5130 ,  1.968731 %
TUU2017  :  17080 ,  3.598721 %
TUU2017  :  13239 ,  3.690509 %
TUU2017  :  24469 ,  9.00092 %
TUU2017  :  1171 ,  26.79021 %
TDUU2017  :  12414 ,  2.68947 %
TDUU2017  :  130302 ,  39.53901 %
TDUU2017  :  40648 ,  21.50438 %
TDUU2017  :  28736 ,  3.330254 %
TDUU2017  :  105814 ,  30.05866 %
TDUU2017  :  58997 ,  6.260412 %
TDUU2017  :  7742 ,  15.86313 %
TDUU2017  :  4995 ,  1.916922 %
TDUU2017  :  16648 ,  3.5077 %
TDUU2017  :  12916 ,  3.600469 %
TDUU2017  :  24037 ,  8.842008 %
TDUU2017  :  1143 ,  26.14962 %
AAV2020  :  18267 ,  3.957511 %
AAV2020  :  182608 ,  55.41081 %
AAV2020  :  57539 ,  30.44037 %
AAV2020  :  40565 ,  4.701134 %
AAV2020  :  154745 ,  43.95853 %
AAV2020  :  87009 ,  9.23288 %
AAV2020  :  11863 ,  24.30694 %
AAV2020  :  7014 ,  2.69175 %
AAV2020  :  23580 ,  4.968258 %
AAV2020  :  18961 ,  5.285576 %
AAV2020  :  33128 ,  12.18613 %
AAV2020  :  1650 ,  37.7488 %
TAAV2017  :  19127 ,  4.143828 %
TAAV2017  :  187873 ,  57.00843 %
TAAV2017  :  60708 ,  32.1169 %
TAAV2017  :  42557 ,  4.931989 %
TAAV2017  :  161369 ,  45.84021 %
TAAV2017  :  90403 ,  9.593031 %
TAAV2017  :  12284 ,  25.16955 %
TAAV2017  :  7418 ,  2.846792 %
TAAV2017  :  24753 ,  5.215407 %
TAAV2017  :  19891 ,  5.544823 %
TAAV2017  :  34073 ,  12.53375 %
TAAV2017  :  1721 ,  39.37314 %
TDAAV2017  :  18536 ,  4.015789 %
TDAAV2017  :  183992 ,  55.83078 %
TDAAV2017  :  58395 ,  30.89323 %
TDAAV2017  :  41121 ,  4.765569 %
TDAAV2017  :  156580 ,  44.4798 %
TDAAV2017  :  87967 ,  9.334537 %
TDAAV2017  :  11958 ,  24.50159 %
TDAAV2017  :  7133 ,  2.737418 %
TDAAV2017  :  23896 ,  5.034839 %
TDAAV2017  :  19213 ,  5.355824 %
TDAAV2017  :  33393 ,  12.28361 %
TDAAV2017  :  1672 ,  38.25212 %
CATEAAV2020  :  12324 ,  2.669971 %
CATEAAV2020  :  133449 ,  40.49394 %
CATEAAV2020  :  44959 ,  23.78506 %
CATEAAV2020  :  30259 ,  3.506757 %
CATEAAV2020  :  110689 ,  31.44351 %
CATEAAV2020  :  61581 ,  6.534611 %
CATEAAV2020  :  7336 ,  15.03125 %
CATEAAV2020  :  5335 ,  2.047403 %
CATEAAV2020  :  16993 ,  3.580391 %
CATEAAV2020  :  13863 ,  3.864456 %
CATEAAV2020  :  22033 ,  8.104837 %
CATEAAV2020  :  1189 ,  27.20201 %
BV2012  :  14961 ,  3.241272 %
BV2012  :  157379 ,  47.75529 %
BV2012  :  45675 ,  24.16385 %
BV2012  :  33662 ,  3.901135 %
BV2012  :  129936 ,  36.91101 %
BV2012  :  72775 ,  7.722452 %
BV2012  :  9692 ,  19.85862 %
BV2012  :  5627 ,  2.159463 %
BV2012  :  19601 ,  4.129891 %
BV2012  :  15328 ,  4.27284 %
BV2012  :  28803 ,  10.59518 %
BV2012  :  1401 ,  32.05216 %
'''

