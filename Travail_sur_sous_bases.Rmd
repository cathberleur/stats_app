---
title: "Travail sur sous-bases d'1 type de délinquance"
author: "Bracq"
date: "2023-01-25"
header-includes:
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyhead{}
- \fancyfoot{}
- \fancyhead[CO,CE]{Poing Levé}
- \fancyfoot[CO,CE]{Sondage}
- \fancyfoot[R]{\thepage}
output:
  pdf_document:
    toc: yes
    toc_depth : 3
    latex_engine: xelatex
  html_document:
    toc: yes
editor_options: 
  markdown: 
    wrap: sentence
---

```{=html}
<style>
body {
text-align: justify}
</style>
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

```

```{r, include=FALSE}
list.of.packages <- c("tidyverse", "haven", "readxl", "stats", "ggplot2", "ggcorrplot", "data.table", "dplyr", "corrplot", "stargazer", "Hmisc",'cartography','sf','rgdal','sp','xlsx')
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages, repos = "http://cran.us.r-project.org")

invisible(lapply(list.of.packages, library, character.only = TRUE))

setwd("~/Documents/ENSAE/Stats_app")
```


```{r, charger-libraries}
library(sf)
library(rgdal)
library(cartography)
library(sp)
library(dplyr)
library(tibble)
library(data.table)
library(reshape2)
```

Le but étant d'alléger la base, penser à nettoyer le "global environment" avant de charger une sous-base. A exécuter après la feuille mise_en_forme_donnees (ou changer le lien de chargement des fichiers si ils sont enregistrés ailleurs pour ne pas les recréer inutilement à chaque fois)

```{r, chargement-d-une-sous-base}
t.del.A <- readRDS("~/GitHub/stats_app/del_merged_A.rds")
#t.del.A <- readRDS("C:\\Users\\marie\\OneDrive\\Documents\\cours\\ensae\\stat app\\sous df\\del_merged_A.rds")
t.del.O <- readRDS("~/GitHub/stats_app/del_merged_O.rds")


#A <- readRDS(file = "C:\\Users\\marie\\Documents\\GitHub\\stats_app\\del_merged_A.rds")
#A <- readRDS(file = "C:/Users/Utilisateur/Documents/GitHub/stats_app/del_merged_A.rds")#clem
```

on cherche quels zonages permettent au mieux de regrouper les trois adresses d'une observation :
idée : (pas sûre que ce soit la manière la + ergonomique de faire)
pour cela, on veut créer une indicatrice qui indique si les 3 communes appartiennent au même zonage ou non, pour chaque zonage
(on fait ensuite la somme pour avoir l'effectif / proportion --> /3 car on a triplé les lignes en passant au format long)

idem avec 2 communes --> il faut faire infraction + mec et infraction + victime et? victime + mec ? (est-ce que toutes ces infos sont pertinentes ??)

l'idéal est d'avoir une fonction qui prend en argument la sous-base pour qu'on puisse faire la même chose pour tous les types de délinquance, mais on commence sans fonction sur la sous-base O(la moins lourde)

```{r essai}
t.del.O['indicEPCI'] = 1
t.del.O <- t.del.O %>% select(-'indicEPCI')

```

Autre idée : pour un zonage donné, boucle sur les id (distincts) --> +1 si les 3 lignes correspondant au même id sont le même zonage --> on obtient l'effectif des infractions où les 3 communes sont dans le même zonage

à transformer en fonction selon zonage après
voir surtout si ça ne prend pas trop de temps à tourner ...
```{r}
unique_id <- unique(t.del.O$id)
effectif_EPCI = 0
#pb quand NA
for (idf in unique_id){
  if (((t.del.O[t.del.O$id == idf,'EPCI'][1,]) == (t.del.O[t.del.O$id == idf,'EPCI'][2,])) & ((t.del.O[t.del.O$id == idf,'EPCI'][1,] == t.del.O[t.del.O$id == idf,'EPCI'][3,])))  effectif_EPCI = effectif_EPCI+1
}

t.del.O[t.del.O$id == 4313218,'EPCI'][3,]
if ((length(t.del.O[t.del.O$id == 4313218,'EPCI'])) == (3)) print('oui')
```





