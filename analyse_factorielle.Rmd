---
title: "Analyse factorielle"
author: "Meyer, Berleur, Sklenard, Bracq"
date: "05/02/2023"
output: html_document
---
header-includes:
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyhead{}
- \fancyfoot{}
- \fancyhead[CO,CE]{Poing Levé}
- \fancyfoot[CO,CE]{Sondage}
- \fancyfoot[R]{\thepage}
output:
  pdf_document:
    toc: yes
    toc_depth : 3
    latex_engine: xelatex
  html_document:
    toc: yes
editor_options: 
  markdown: 
    wrap: sentence
---

```{=html}
<style>
body {
text-align: justify}
</style>
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

```

Il faut d'abord créer une table avec les communes comme individus...

```{r création-base}
df_com_inf <- merge(x=zonages, y=df_1619, by.x='CODGEO', by.y='cog_com_22_inf', all.x=TRUE)#on créé une base avec les communes comme identifiant avec les zonages
df_facto_inf <- df_com_inf %>%
  group_by(CODGEO) %>%
  summarise(sum = sum(), ninf = n())#on compte le nombre d'infraction par commune

#pareil pour les victimes
df_com_vict <- merge(x=zonages, y=df_1619, by.x='CODGEO', by.y='cog_com_22_vict', all.x=TRUE)
df_facto_vict <- df_com_vict %>%
  group_by(CODGEO) %>%
  summarise(sum = sum(), nvict = n())

#pareil pour les mec
df_com_mec <- merge(x=zonages, y=df_1619, by.x='CODGEO', by.y='cog_com_22_mec', all.x=TRUE)
df_facto_mec <- df_com_mec %>%
  group_by(CODGEO) %>%
  summarise(sum = sum(), nmec = n())

#on merge les trois tables
df_com_facto_mec_inf <- merge(x=df_facto_mec, y=df_facto_inf, by.x='CODGEO', by.y='CODGEO', all.x=TRUE)

df_facto <- merge(x=df_com_facto_mec_inf, y=df_facto_vict, by.x='CODGEO', by.y='CODGEO', all.x=TRUE)

rm(df_1619, df_com_facto_mec_inf, df_com_mec, df_com_inf, df_com_vict, df_facto_mec, df_facto_inf, df_facto_vict, t.del)#on supprime toutes les bases qui servent à rien

```

```{r}
#on ajoute les zonages qu'on a perdu en route
df_facto_zon <- merge(x=df_facto, y=zonages, by.x='CODGEO', by.y='CODGEO', all.x=TRUE)
```


```{r chargement-packages}
library(questionr)
library(FactoMineR)
library(dplyr)
library(factoextra)
library(Factoshiny)
library(explor)
```

On a ici à la fois des variables quanti (nvict) et quali (zonages). 2 solutions : recoder ou AFMD

#sol 1 : FAMD, Analyse Factorielle des Données Mixtes
```{r}
rownames(df_facto_zon) <- paste(df_facto_zon$CODGEO)
df_facto_zon <- df_facto_zon[,-1]
# Factoshiny(df_facto_zon)
res <- FAMD(df_facto_zon)
FAMDshiny(df_facto_zon)

#mon ordi supporte pas
```

#Sol 2 : recodage et ACM
```{r creation-classes}
df_facto_zon$nvictcl <- cut(df_facto_zon$nvict,  breaks = c(0, 10, 50, 100, 500, 1000, 5000, 10000, 50000), include.lowest = TRUE)
df_facto_zon$ninfcl <- cut(df_facto_zon$ninf, breaks = c(0, 10, 50, 100, 500, 1000, 5000, 10000, 50000), include.lowest = TRUE)
df_facto_zon$nmeccl <- cut(df_facto_zon$nmec, breaks = c(0, 10, 50, 100, 500, 1000, 5000, 10000, 50000), include.lowest = TRUE)
df_facto_zon[ , c('sum.x', 'nmec', 'sum.y', 'ninf', 'sum', 'nvict')] <- list(NULL)#on supprime le reste
```

```{r ACM}
resultat <- MCA(df_facto_zon, quali.sup = c(1,2,3, 4, 5, 6, 7, 8, 9, 10, 11,12, 13, 14, 15, 16))

#Erreur : impossible d'allouer un vecteur de taille 4.3 Go (prend trop de mémoire vive)


explor(resultat)
Factoshiny(resultat)
```

Sans les zonages :
```{r ACM-sans-zonages}
rownames(df_facto) <- paste(df_facto$CODGEO)
df_facto <- df_facto[,-1]
df_facto$nvictcl <- cut(df_facto$nvict,  breaks = c(0, 10, 50, 100, 500, 1000, 5000, 10000, 50000), include.lowest = TRUE)
df_facto$ninfcl <- cut(df_facto$ninf, breaks = c(0, 10, 50, 100, 500, 1000, 5000, 10000, 50000), include.lowest = TRUE)
df_facto$nmeccl <- cut(df_facto$nmec, breaks = c(0, 10, 50, 100, 500, 1000, 5000, 10000, 50000), include.lowest = TRUE)
df_facto[ , c('sum.x', 'nmec', 'sum.y', 'ninf', 'sum', 'nvict')] <- list(NULL)#on supprime le reste
resultat <- MCA(df_facto_zon)

#Erreur : impossible d'allouer un vecteur de taille 4.3 Go
```





